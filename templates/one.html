{% extends "index.html" %}

{% block title %}å–®å¼µé¡¯ç¤º{% endblock %}

{% block filter %}{% endblock %}

{% block content %}
<div id="cardResult">
    <p style="color:#00e0ff; font-size: 20px;">ğŸ” æ­£åœ¨è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™...</p>
</div>

<style>
    main.page-one {
        background: linear-gradient(135deg, #181c2f 0%, #2d3350 30%, #232946 50%, #1a1a2e 100%);
        color: #dff9ff;
        font-family: "Orbitron", sans-serif;
        height: 1500%;
        padding: 2rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    window.onload = () => {
        const base64 = sessionStorage.getItem('uploadedImage');
        if (!base64) {
            console.log("âš ï¸ æ²’æœ‰åœ–ç‰‡å¯è¾¨è­˜");
            return;
        }

        console.log("ğŸ“¤ ç™¼é€è¾¨è­˜è«‹æ±‚...");

        const byteString = atob(base64.split(',')[1]);
        const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: mimeString });
        const file = new File([blob], 'upload.jpg', { type: mimeString });

        const formData = new FormData();
        formData.append('image', file);

        fetch('/match_one', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const result = document.getElementById('cardResult');
            if (!result) return;

            if (data.images_html && data.text_html) {
                result.innerHTML = `
                    <h2 style="padding: 0rem 0rem 1.5rem 2rem; font-size: large;">é€™å¼µå¡ç‰‡çš„è³‡è¨Š</h2>
                    <div class="card-list single-column">
                      <div class="card-item">
                        <div class="card-images">
                          ${data.images_html}
                        </div>
                        <div class="card-text" id="textBlock">
                          ${data.text_html}
                          <i id="priceLoading" style="color:gray;">ğŸ” æ­£åœ¨æŸ¥è©¢åƒ¹æ ¼...</i>
                        </div>
                      </div>
                    </div>
                `;

                if (data.card_name_jp) {
                    fetch('/get_price', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ card_name_jp: data.card_name_jp })
                    })
                    .then(res => res.json())
                    .then(priceData => {
                        const textBlock = document.getElementById('textBlock');
                        const priceLoading = document.getElementById('priceLoading');
                        if (textBlock && priceData.price_html) {
                            if (priceLoading) priceLoading.remove();
                            textBlock.innerHTML += priceData.price_html;
                        }
                    })
                    .catch(err => {
                        console.warn("âš ï¸ åƒ¹æ ¼æŸ¥è©¢å¤±æ•—", err);
                        const priceLoading = document.getElementById('priceLoading');
                        if (priceLoading) {
                            priceLoading.innerHTML = "âš ï¸ åƒ¹æ ¼æŸ¥è©¢å¤±æ•—";
                            priceLoading.style.color = "orange";
                        }
                    });
                }
            } else if (data.error) {
                result.innerHTML = `<span style="color:red;">${data.error}</span>`;
            } else {
                result.innerHTML = `<span style="color:red; font-size: 20px;">âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦</span>`;
            }

            sessionStorage.removeItem('uploadedImage');
        })
        .catch(err => {
            console.error('âŒ ç™¼é€è³‡æ–™å¤±æ•—', err);
            const result = document.getElementById('cardResult');
            if (result) result.innerHTML = 'âŒ ç™¼é€è³‡æ–™å¤±æ•—';
        });
    };
</script>
{% endblock %}
